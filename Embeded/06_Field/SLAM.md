
[北斗导航真的能达到毫米级定位精度吗？](https://www.zhihu.com/question/65638680/answer/233896068)
[新品新品：冰河导航660RTK双频上市](https://zhuanlan.zhihu.com/p/510526208)
[IMU的数据如何采集](https://www.bilibili.com/video/BV1214y1u741/?spm_id_from=333.999.0.0)  
[RTK差分原理介绍](https://www.bilibili.com/video/BV1XR4y1A7b2/?spm_id_from=333.999.0.0)  
[GPS坐标（大地坐标）转高斯平面坐标，并计算 GPS 坐标（大地坐标）两点间的距离...](https://blog.csdn.net/weixin_33895604/article/details/93930991)
[可能是北半球最便宜的IMU芯片](https://www.bilibili.com/video/BV1924y1W7re/)
[云卓S1定向套装视频教程](https://www.bilibili.com/video/BV1MG411J7rJ/)
[合宙Luat - 合宙Luat](https://gitee.com/openLuat)
[高德地图API](https://lbs.amap.com/tools/picker)
[GPS 定位纠偏 - Luat，让通信更优雅 - 上海合宙通信科技有限公司](https://www.openluat.com/GPS-Offset.html)
[手机GPS为什么能在室内定位-华测导航](https://www.huace.cn/about/news_show/34)
[计算GPS WGS_84 两点的距离 - osnosn - 博客园](https://www.cnblogs.com/osnosn/p/14505778.html)
[(135条消息) GPS坐标（大地坐标）转高斯平面坐标，并计算 GPS 坐标（大地坐标）两点间的距离..._weixin_33895604的博客-CSDN博客](https://blog.csdn.net/weixin_33895604/article/details/93930991)
[Micropython——六轴MPU6050模块的使用_mpu6050任意角度校准-CSDN博客](https://blog.csdn.net/qq_45779334/article/details/113122089?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170278911416800184144768%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=170278911416800184144768&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-113122089-null-null.142^v96^pc_search_result_base7&utm_term=Micropython%E2%80%94%E2%80%94%E5%85%AD%E8%BD%B4MPU6050%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8&spm=1018.2226.3001.4187)
[STM32--MPU6050 DMP读角度总结_mpu6050如何测量角度-CSDN博客](https://blog.csdn.net/QWQ_DIODA/article/details/116533025?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170278908916800182169350%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=170278908916800182169350&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-116533025-null-null.142^v96^pc_search_result_base7&utm_term=STM32--MPU6050%20DMP%E8%AF%BB%E8%A7%92%E5%BA%A6%E6%80%BB%E7%BB%93&spm=1018.2226.3001.4187)
[【经纬度查询】在线地图经度纬度查询|经纬度地名坐标转换](https://map.jiqrxx.com/jingweidu/#:~:text=%E7%BB%8F%E7%BA%AC%E5%BA%A6%E6%9F%A5%E8%AF%A2%E5%9C%B0%E5%9B%BE%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%EF%BC%9A,1%E3%80%81%E7%82%B9%E5%87%BB%E5%9C%B0%E5%9B%BE%E4%B8%8A%E7%9A%84%E4%BB%BB%E6%84%8F%E4%B8%80%E7%82%B9%EF%BC%8C%E5%8D%B3%E5%8F%AF%E6%9F%A5%E7%9C%8B%E8%AF%A5%E5%9C%B0%E7%9A%84%E7%BB%8F%E7%BA%AC%E5%BA%A6%E5%9D%90%E6%A0%87%EF%BC%9B%202%E3%80%81%E5%9C%A8%E6%90%9C%E7%B4%A2%E6%A1%86%E8%BE%93%E5%85%A5%E5%9C%B0%E5%90%8D%E5%90%8E%EF%BC%8C%E7%82%B9%E5%87%BB%E2%80%9C%E8%A7%A3%E6%9E%90%E7%BB%8F%E7%BA%AC%E5%BA%A6%E2%80%9D%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9B%B4%E6%8E%A5%E8%BF%9B%E5%85%A5%E5%88%B0%E8%AF%A5%E5%9C%B0%EF%BC%8C%E5%B9%B6%E5%8F%AF%E6%9F%A5%E7%9C%8B%E8%AF%A5%E5%9C%B0%E7%9A%84%E7%BB%8F%E5%BA%A6%E5%92%8C%E7%BA%AC%E5%BA%A6%EF%BC%9B)
#### MPU6050官方DMP的移植和使用

之前在《[MPU6050陀螺仪和加速度计数据的获取与校准](http://mp.weixin.qq.com/s?__biz=MjM5NDQ0NjM5Mg==&mid=2650509007&idx=7&sn=1d754a196f8c56f7d4708ad0cfaa9209&chksm=be88839889ff0a8e391345dcaba0d554ab92aa59ef0cc627a733d7348d6cd80cbf322100da76&scene=21#wechat_redirect)》文章中，我们使I2C总线获取了MPU6050的三轴加速度、三轴角速度，并且介绍了一种简单的初始状态校准方法。

今天，我们继续在已有的底层驱动基础上，移植MPU6050芯片官方的DMP库，来获取角度信息。

##### 1、姿态角计算的一些基础知识

在上一节中，我们初始化时约定了Z轴向上，也即知道了初始的角度；再加上后续获取的实时的角速度，利用角速度进行积分，就可以获取姿态角信息。

在实际编程实现时，积分就是累加和，随着时间的增加，积分（累加）的数据越来越多，误差也会越来越大。因此，单独使用陀螺仪的角速度去计算得到姿态角是不行的，误差会越来越大，需要使用加速度计的值来修正。

为什么加速度计的值可以来修正角度呢？我们知道，加速度计能测到重力加速度的方向，只要飞行器的运动不算太剧烈，就能近似地认为在一段时间里，加速度计的测量值只有重力，而且姿态角的变化只转过了很小的一个角。

我们仍以下图为例，假定初始时Z轴向上，绕X轴旋转的角度为滚转角；绕Y轴旋转的角度为俯仰角，绕Z轴旋转的角度为偏航角。

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqjLl3y98XzHQ3NG5ictW6jXtj46kwWngZ8tCIsHkU0oJVJOn3UBlNiauw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqjLl3y98XzHQ3NG5ictW6jXtj46kwWngZ8tCIsHkU0oJVJOn3UBlNiauw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

那么，滚转角（绕X轴转）和俯仰角（绕Y轴转）发生变化时，MPU6050测出来的重力加速度g的方向也会发送变化。而加速度计测出来的重力加速度g的方向是实时的，不会受长时间计算累加的影响。所以，我们可以用加速度计测到的g的方向，来修正陀螺仪积分得到的滚转角和俯仰角。

而偏航角（绕Z轴转）变化时，MPU6050测到的重力加速度g方向是不会变化的，所以g的方向不能用来修正偏航角。要想修正偏航角，需要测量地磁偏角的传感器信息。

这个用加速度计或磁力计来修正姿态角的过程，一般称为数据融合，有多种方法实现，如果想要自己写算法实现，有互补滤波、卡尔曼滤波等方法，或者直接使用MPU6050官方提供的DMP库。

DMP全称Digital Motion Processor，是Invensense公司针对其产品推出的软件包，能直接输出四元数，可以减轻外围微处理器的工作负担且避免了繁琐的滤波和数据融合，适用于MPU6050、MPU6500、MPU9150、MPU9250等传感器。本文就是重点介绍DMP库的移植和使用。

这里再提一点浅显的四元数的知识，四元数是一种表示姿态角的方法，可以认为四元数等价为滚转角、俯仰角、偏航角。在姿态解算时，之所以要使用四元数，是因为它可以简化姿态更新的计算过程。

MPU6050的DMP库能直接输出四元数，是将陀螺仪的角速度、加速度计的加速度融合之后的结果，由该输出的四元数表示的姿态角是经过加速度计修正过的。

##### 2、MPU6050官方DMP库的移植

MPU6050官方的DMP库是适用于MSP430的，我们使用时，需要简单地移植一下。

这里使用的是5.1版本的库，官方库一共只有下面这几个文件：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqqBLN5NmR3FTaMe7TKTthSXy1ad3S60tpCNDlhBxbyNNaQ9koRiagh7g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqqBLN5NmR3FTaMe7TKTthSXy1ad3S60tpCNDlhBxbyNNaQ9koRiagh7g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

另外官方库中有一个适用于MSP430单片机的app程序，就是motion_driver_test.c文件，但是这个文件里有比较多的和上位机通信用的测试代码，实际需要的很少，我们可以参考它写自己的应用程序。

下面，我们就开始移植DMP库。

首先，将上图的文件都拷贝到已有的MPU6050工程目录下，添加到keil工程中。

打开inv_mpu.c文件，可以看到文件起始有一串宏定义，这是我们需要移植的主要部分。

文件中可以看到定义了几种处理器类型，以MSP430为例，定义了I2C读写函数i2c_write、i2c_read，延时函数delay_ms、get_ms，打印log函数、取绝对值函数、比较大小函数等等。我们仿照它编写适用于STM32的函数如下：

I2C的读写适用HAL库的读写函数实现，延时函数也使用HAL已有的HAL_Delay和HAL_GetTick实现。

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqNkmyhqMZGs2X3WZvZwvqwE1QCQ0739lRxflqBRZPHIhlMK2FEUjo2g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqNkmyhqMZGs2X3WZvZwvqwE1QCQ0739lRxflqBRZPHIhlMK2FEUjo2g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

找到inv_mpu.c文件中的mpu_init函数，将其中下面几行注释掉：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqo7JcU84bKqXfLe7DzkACt82SceNxaq6ibtwkB0zTGjIicezWNdkLvm7g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqo7JcU84bKqXfLe7DzkACt82SceNxaq6ibtwkB0zTGjIicezWNdkLvm7g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

在inv_mpu.h文件中找到struct int_param_s{}结构体定义的地方，在里面增加一个成员void *temp，否则编译会报错，因为我们没有定义结构体中的宏，会导致结构体内是空的（使用其他的修改方式也行，只要没有语法错误，能编译通过就行）：

在inv_mpu_dmp_motion_driver.c这个文件中，开始处添加宏定义，与inv_mpu.c中的实现是一样的：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqbU2xjzJzk3iaxTY6T5E0J09PehFSsPnu3E5TJB2hvZvzZZfnb0dicVIw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqbU2xjzJzk3iaxTY6T5E0J09PehFSsPnu3E5TJB2hvZvzZZfnb0dicVIw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

做完上面这些，编译可以通过，MPU6050官方的DMP库就移植好了。

##### 3、MPU6050的DMP库使用

移植完以后，我们可以参照官方的例子motion_driver_test.c，来编写我们自己的应用程序。主要就是两步：初始化和循环获取数据。

首先我们看初始化，就是mpu_dmp_init这个函数，具体的实现如下：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqob6toLsTxVNDeaiaRCbTKUJo7Ee2qlCJ7gtfNRo8DB7nlgOpwRylPZg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqob6toLsTxVNDeaiaRCbTKUJo7Ee2qlCJ7gtfNRo8DB7nlgOpwRylPZg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

具体每个步骤的含义注释都有，函数实现也是官方例子里都有的，就不一一解释了。

需要注意的是，执行run_self_test()这一步时，调用了mpu_run_self_test这个函数，官方的函数说明中，要求自行自检时，Z轴竖直向上或者竖直向下：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqN7NK0xrvGDsXJMPLfCJn3mO48n6ADWSm6Dic3rMb5M6s7svmvDDdNzw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqN7NK0xrvGDsXJMPLfCJn3mO48n6ADWSm6Dic3rMb5M6s7svmvDDdNzw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

获取数据的函数如下：

就是调用dmp_read_fifo函数，获取融合后的四元数，放在quat数组中；然后将四元数，除以1073741824.0f（q30）的系数，再计算反三角函数得到俯仰角、滚转角、偏航角：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqtWqBmoRic34IKCLYDlOibj5K0GicRMeKQbV3vW4CSJTZnNXVJqgHajrBA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqtWqBmoRic34IKCLYDlOibj5K0GicRMeKQbV3vW4CSJTZnNXVJqgHajrBA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

整个测试函数如下所示，先调用mpu_dmp_init初始化，然后主循环中周期性地调用mpu_dmp_get_data获取姿态角：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqRHmMLThSTobZ3XulFfQKLyPvicTA1jMfjia1lMQW0xicJtrv8thGmWAqA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqRHmMLThSTobZ3XulFfQKLyPvicTA1jMfjia1lMQW0xicJtrv8thGmWAqA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

将DMP_test函数放到main函数硬件初始化之后。编译下载运行。

可以看到，初始时输出的姿态角：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqPPBzjsKicqjAibAoCvOYictIHw4O6icTwBzhD8U6BlImKc2GqgRfw9moWw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqPPBzjsKicqjAibAoCvOYictIHw4O6icTwBzhD8U6BlImKc2GqgRfw9moWw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

运动中输出的姿态角：

[![](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqU3fJJsT7Xk5EZtsn8ZUAUQWCib6eicTXRbZBRRmKRRtTZC2tPQvnC01Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)](https://mmbiz.qpic.cn/mmbiz_png/ytiaAdR14jmAOaBAysNhGCFFkMoWbaoDqU3fJJsT7Xk5EZtsn8ZUAUQWCib6eicTXRbZBRRmKRRtTZC2tPQvnC01Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

长时间运行，也能保持较高的准确度，姿态角不会产生误差累积，说明DMP库起到了融合陀螺仪和加速度计数据的作用。

好了，本节关于MPU6050的DMP库的移植和使用就讲到这里了，希望这篇文章能对大家有所帮助。
#### 其他
> [!info] 如何系统的学习机器人导航（robotics navigation）？  
> 自动驾驶从业者，与定位组件有过接触，虽然无法提供系统的学习建议，但觉得题主大概率会慢慢接触到 GPS/I...  
> [https://www.zhihu.com/question/451550176/answer/1803405379](https://www.zhihu.com/question/451550176/answer/1803405379)  

[10种室内定位技术原理深度解析-电子发烧友网](http://www.elecfans.com/d/586741.html)



[(134条消息) Micropython——六轴MPU6050模块的使用_Irving.Gao的博客-CSDN博客](https://blog.csdn.net/qq_45779334/article/details/113122089)

[(134条消息) 使用MPU6050 DIY Arduino倾角仪_acktomas的博客-CSDN博客](https://blog.csdn.net/acktomas/article/details/102461770)

[(134条消息) mpu6050加速度角速度融合为四元数计算函数的说明_大志的博客-CSDN博客](https://blog.csdn.net/qq_38288618/article/details/77320646)

[(135条消息) MPU6050应用详解_weixin_30835933的博客-CSDN博客](https://blog.csdn.net/weixin_30835933/article/details/99920397)

[(134条消息) 如何把MPU6050输出的加速度和角速度换算成角度_Fred_1986的博客-CSDN博客](https://blog.csdn.net/Fred_1986/article/details/108397146?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link)

[(134条消息) MPU6050的数据获取、分析与处理_jickjiang的博客-CSDN博客_mpu6050输出的数据是什么](https://blog.csdn.net/jickjiang/article/details/84237863)

[(134条消息) MPU 6050姿态角度融合算法_Fred_1986的博客-CSDN博客](https://blog.csdn.net/Fred_1986/article/details/108522529?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163773589516780357217271%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=163773589516780357217271&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-14-108522529.first_rank_v2_pc_rank_v29&utm_term=mpu6050%E8%AE%A1%E7%AE%97%E8%A7%92%E5%BA%A6&spm=1018.2226.3001.4187)

[(133条消息) ESP-12F驱动MPU6050使用DMP库姿态解算_明镜台-CSDN博客](https://blog.csdn.net/guohengsheng3882/article/details/90672642)